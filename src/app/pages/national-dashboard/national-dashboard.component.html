<!-- Indicador de Carga -->
<div *ngIf="cargando" class="loading-container">
  <div class="spinner"></div>
  <p>Cargando datos del dashboard nacional...</p>
</div>

<!-- Contenedor Principal del Dashboard -->
<div *ngIf="dashboardData$ | async as data" class="dashboard-container fade-in">

  <!-- #################################### -->
  <!-- ##   JERARQU√çA DE METAS FPI       ## -->
  <!-- #################################### -->

  <div class="hierarchy-section">
    <div class="data-section">
      <h2 class="section-title">Metas Formaci√≥n Profesional Integral</h2>

      <!-- Root Node (Parent) usando hierarchyRoot -->
      <div *ngIf="data.hierarchyRoot">
        <!-- Parent Card -->
        <div class="parent-card">
          <div class="parent-header" (click)="toggleHierarchyNode(data.hierarchyRoot)"
               [class.expandable]="data.hierarchyRoot.children.length > 0">
            <div class="parent-title-section">
              <span class="toggle-icon" *ngIf="data.hierarchyRoot.children.length > 0">
                {{ data.hierarchyRoot.isCollapsed ? '‚ñ∫' : '‚ñº' }}
              </span>
              <h3 class="parent-title">{{ removeParentheses(data.hierarchyRoot.descripcion) }}</h3>
            </div>
            <div class="parent-metrics">
              <div class="parent-metric">
                <span class="metric-label">Meta:</span>
                <span class="metric-value-large">{{ data.hierarchyRoot.meta | number:'1.0-0' }}</span>
              </div>
              <div class="parent-metric">
                <span class="metric-label">Ejecuci√≥n:</span>
                <span class="metric-value-large">{{ data.hierarchyRoot.ejecucion | number:'1.0-0' }}</span>
              </div>
            </div>
          </div>

          <!-- Progress Bar -->
          <div class="parent-progress-section">
            <div class="progress" [class.has-overflow]="data.hierarchyRoot.porcentaje > 100">
              <div class="progress-bar" [ngClass]="getClasePorcentaje(data.hierarchyRoot.porcentaje / 100)"
                [style.width.%]="data.hierarchyRoot.porcentaje > 100 ? 100 : data.hierarchyRoot.porcentaje">
                {{ data.hierarchyRoot.porcentaje / 100 | percent:'1.2-2' }}
              </div>
            </div>
          </div>

          <!-- Children Cards (Horizontal Layout) - Solo segundo nivel -->
          <div class="children-cards-grid" *ngIf="!data.hierarchyRoot.isCollapsed && data.hierarchyRoot.children.length > 0">
            <div class="child-card"
                 *ngFor="let child of getSecondLevelChildren(data.hierarchyRoot); trackBy: trackByHierarchyId"
                 [class.child-card-selected]="isNodeSelectedForTree(child)"
                 (click)="selectNodeForTree(child)">
              <div class="child-card-header">
                <h4 class="child-title">{{ removeParentheses(child.descripcion) }}</h4>
              </div>

              <div class="child-metrics">
                <div class="progress" [class.has-overflow]="child.porcentaje > 100">
                  <div class="progress-bar" [ngClass]="getClasePorcentaje(child.porcentaje / 100)"
                    [style.width.%]="child.porcentaje > 100 ? 100 : child.porcentaje">
                    {{ child.porcentaje / 100 | percent:'1.2-2' }}
                  </div>
                </div>

                <div class="child-values">
                  <div class="value-item">
                    <span class="value-label">Meta:</span>
                    <span class="value-number">{{ child.meta | number:'1.0-0' }}</span>
                  </div>
                  <div class="value-item">
                    <span class="value-label">Ejecuci√≥n:</span>
                    <span class="value-number">{{ child.ejecucion | number:'1.0-0' }}</span>
                  </div>
                </div>
              </div>

              <!-- Indicador de hijos disponibles -->
              <div class="child-has-details" *ngIf="child.children.length > 0">
                <span class="details-icon">üìä</span>
                <span class="details-text">Click para ver detalles ({{ child.children.length }} √≠tems)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de √Årbol para nodo seleccionado -->
    <div *ngIf="selectedNodeForTree" class="data-section selected-node-tree-section">
      <div class="selected-node-header">
        <h2 class="section-title">{{ removeParentheses(selectedNodeForTree.descripcion) }}</h2>
        <button class="close-tree-btn" (click)="selectedNodeForTree = null">‚úï Cerrar</button>
      </div>

      <!-- Mostrar solo los hijos, no el nodo padre -->
      <div class="children-tree-container" *ngIf="selectedNodeForTree.children.length > 0">
        <div *ngFor="let child of selectedNodeForTree.children; trackBy: trackByHierarchyId">
          <ng-container *ngTemplateOutlet="hierarchyNodeTpl; context: { $implicit: child }"></ng-container>
        </div>
      </div>
      <div class="no-children-message" *ngIf="selectedNodeForTree.children.length === 0">
        <p>No hay elementos de detalle para mostrar.</p>
      </div>
    </div>
  </div>


  <!-- #################################### -->
  <!-- ##      SECCIONES ADICIONALES     ## -->
  <!-- #################################### -->
  <div class="additional-sections">
    <!-- Secci√≥n: Formaci√≥n por Estrategia -->
    <div *ngIf="data.formacionEstrategiaRoot" class="data-section">
      <h2 class="section-title">Metas por Estrategias de Formaci√≥n</h2>

      <!-- Tarjetas Directas (sin tarjeta padre, solo las hijas) -->
      <div class="children-cards-grid">
        <div class="child-card estrategia-child-card"
             *ngFor="let child of data.formacionEstrategiaRoot.children; trackBy: trackByEstrategiaId"
             [class.child-card-selected]="isEstrategiaNodeSelectedForTree(child)"
             (click)="selectEstrategiaNodeForTree(child)">
          <div class="child-card-header">
            <h4 class="child-title">{{ removeParentheses(child.nivelFormacion) }}</h4>
          </div>

          <!-- Grid de Estrategias con meta/ejecuci√≥n expl√≠cita -->
          <div class="estrategias-grid-explicit">
            <!-- Regular -->
            <div class="estrategia-explicit-item" *ngIf="child.regularMeta !== null">
              <h5 class="estrategia-explicit-label">Regular</h5>
              <div class="progress" [class.has-overflow]="calcularPorcentaje(child.regularMeta, child.regularEjecucion) > 1">
                <div class="progress-bar"
                     [ngClass]="getClasePorcentaje(calcularPorcentaje(child.regularMeta, child.regularEjecucion))"
                     [style.width.%]="calcularPorcentaje(child.regularMeta, child.regularEjecucion) > 1 ? 100 : calcularPorcentaje(child.regularMeta, child.regularEjecucion) * 100">
                  {{ calcularPorcentaje(child.regularMeta, child.regularEjecucion) | percent:'1.2-2' }}
                </div>
              </div>
              <div class="estrategia-explicit-values">
                <div class="value-item">
                  <span class="value-label">Meta:</span>
                  <span class="value-number">{{ child.regularMeta | number:'1.0-0' }}</span>
                </div>
                <div class="value-item">
                  <span class="value-label">Ejecuci√≥n:</span>
                  <span class="value-number">{{ child.regularEjecucion | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>

            <!-- CampeSENA -->
            <div class="estrategia-explicit-item" *ngIf="child.campesenaMeta !== null">
              <h5 class="estrategia-explicit-label">CampeSENA</h5>
              <div class="progress" [class.has-overflow]="calcularPorcentaje(child.campesenaMeta, child.campesenaEjecucion) > 1">
                <div class="progress-bar"
                     [ngClass]="getClasePorcentaje(calcularPorcentaje(child.campesenaMeta, child.campesenaEjecucion))"
                     [style.width.%]="calcularPorcentaje(child.campesenaMeta, child.campesenaEjecucion) > 1 ? 100 : calcularPorcentaje(child.campesenaMeta, child.campesenaEjecucion) * 100">
                  {{ calcularPorcentaje(child.campesenaMeta, child.campesenaEjecucion) | percent:'1.2-2' }}
                </div>
              </div>
              <div class="estrategia-explicit-values">
                <div class="value-item">
                  <span class="value-label">Meta:</span>
                  <span class="value-number">{{ child.campesenaMeta | number:'1.0-0' }}</span>
                </div>
                <div class="value-item">
                  <span class="value-label">Ejecuci√≥n:</span>
                  <span class="value-number">{{ child.campesenaEjecucion | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>

            <!-- Full Popular -->
            <div class="estrategia-explicit-item" *ngIf="child.fullPopularMeta !== null">
              <h5 class="estrategia-explicit-label">Full Popular</h5>
              <div class="progress" [class.has-overflow]="calcularPorcentaje(child.fullPopularMeta, child.fullPopularEjecucion) > 1">
                <div class="progress-bar"
                     [ngClass]="getClasePorcentaje(calcularPorcentaje(child.fullPopularMeta, child.fullPopularEjecucion))"
                     [style.width.%]="calcularPorcentaje(child.fullPopularMeta, child.fullPopularEjecucion) > 1 ? 100 : calcularPorcentaje(child.fullPopularMeta, child.fullPopularEjecucion) * 100">
                  {{ calcularPorcentaje(child.fullPopularMeta, child.fullPopularEjecucion) | percent:'1.2-2' }}
                </div>
              </div>
              <div class="estrategia-explicit-values">
                <div class="value-item">
                  <span class="value-label">Meta:</span>
                  <span class="value-number">{{ child.fullPopularMeta | number:'1.0-0' }}</span>
                </div>
                <div class="value-item">
                  <span class="value-label">Ejecuci√≥n:</span>
                  <span class="value-number">{{ child.fullPopularEjecucion | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Indicador de hijos disponibles -->
          <div class="child-has-details" *ngIf="child.children.length > 0">
            <span class="details-icon">üìä</span>
            <span class="details-text">Click para ver detalles ({{ child.children.length }} √≠tems)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de Estrategias para nodo seleccionado -->
    <div *ngIf="selectedEstrategiaNodeForTree" class="data-section selected-node-tree-section">
      <div class="selected-node-header">
        <h2 class="section-title">{{ removeParentheses(selectedEstrategiaNodeForTree.nivelFormacion) }}</h2>
        <button class="close-tree-btn" (click)="selectedEstrategiaNodeForTree = null">‚úï Cerrar</button>
      </div>

      <!-- Mostrar solo los hijos, no el nodo padre -->
      <div class="children-tree-container" *ngIf="selectedEstrategiaNodeForTree.children.length > 0">
        <div *ngFor="let child of selectedEstrategiaNodeForTree.children; trackBy: trackByEstrategiaId">
          <ng-container *ngTemplateOutlet="formacionEstrategiaNodeTpl; context: { $implicit: child }"></ng-container>
        </div>
      </div>
      <div class="no-children-message" *ngIf="selectedEstrategiaNodeForTree.children.length === 0">
        <p>No hay elementos de detalle para mostrar.</p>
      </div>
    </div>

    <!-- Secci√≥n: Metas Programas Relevantes -->
    <div *ngIf="data.programasRelevantes && data.programasRelevantes.length > 0" class="data-section">
      <h2 class="section-title">Metas Programas Relevantes</h2>

      <!-- Grid de 3 Programas -->
      <div class="programas-grid">
        <div class="programa-card" *ngFor="let programa of data.programasRelevantes; trackBy: trackById">
          <div class="programa-card-header">
            <h4 class="programa-title">{{ programa.descripcion }}</h4>
          </div>

          <div class="programa-metrics">
            <div class="progress" [class.has-overflow]="programa.porcentaje > 100">
              <div class="progress-bar" [ngClass]="getClasePorcentaje(programa.porcentaje / 100)"
                [style.width.%]="programa.porcentaje > 100 ? 100 : programa.porcentaje">
                {{ programa.porcentaje / 100 | percent:'1.2-2' }}
              </div>
            </div>

            <div class="programa-values">
              <div class="value-item">
                <span class="value-label">Meta:</span>
                <span class="value-number">{{ programa.meta | number:'1.0-0' }}</span>
              </div>
              <div class="value-item">
                <span class="value-label">Ejecutado:</span>
                <span class="value-number">{{ programa.ejecucion | number:'1.0-0' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n: Metas Primer Curso
    <div *ngIf="data.metasPrimerCurso" class="data-section">
      <h2 class="section-title">Metas Primer Curso</h2>

       Tarjeta √∫nica centrada 
      <div class="primer-curso-container">
        <div class="primer-curso-card">
          <div class="primer-curso-header">
            <h4 class="primer-curso-title">{{ data.metasPrimerCurso.descripcion }}</h4>
          </div>

          <div class="primer-curso-metrics">
            <div class="progress" [class.has-overflow]="data.metasPrimerCurso.porcentaje > 100">
              <div class="progress-bar" [ngClass]="getClasePorcentaje(data.metasPrimerCurso.porcentaje / 100)"
                   [style.width.%]="data.metasPrimerCurso.porcentaje > 100 ? 100 : data.metasPrimerCurso.porcentaje">
                {{ data.metasPrimerCurso.porcentaje / 100 | percent:'1.2-2' }}
              </div>
            </div>

            <div class="primer-curso-values">
              <div class="value-item-large">
                <span class="value-label">Meta:</span>
                <span class="value-number-large">{{ data.metasPrimerCurso.meta | number:'1.0-0' }}</span>
              </div>
              <div class="value-item-large">
                <span class="value-label">Ejecutado:</span>
                <span class="value-number-large">{{ data.metasPrimerCurso.ejecucion | number:'1.0-0' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> -->

    <!-- Secci√≥n: M√©tricas Principales -->
    <div *ngIf="data.metricasAdicionales" class="data-section">
      <ng-container *ngFor="let key of getMetricasKeys(data.metricasAdicionales); let first = first">
        <ng-container *ngIf="first">
          <h2 class="section-title">{{ key }}</h2>

          <!-- Layout Principal: 3 columnas (1 compacta + 2 grandes) -->
          <div class="metricas-principales-layout">

            <!-- Columna 1: INSCRITOS + VACANTES (vertical) -->
            <div class="metricas-basicas-columna">
              <!-- INSCRITOS -->
              <div class="programa-card programa-card-compacto">
                <div class="programa-card-header">
                  <h4 class="programa-title">{{ getMetricasPrincipales(data.metricasAdicionales[key])[0].nombreMetrica
                    }}</h4>
                </div>

                <div class="programa-metrics">
                  <div class="progress"
                    [class.has-overflow]="calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[0].meta, getMetricasPrincipales(data.metricasAdicionales[key])[0].ejecucion) > 1">
                    <div class="progress-bar"
                      [ngClass]="getClasePorcentaje(calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[0].meta, getMetricasPrincipales(data.metricasAdicionales[key])[0].ejecucion))"
                      [style.width.%]="calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[0].meta, getMetricasPrincipales(data.metricasAdicionales[key])[0].ejecucion) > 1 ? 100 : calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[0].meta, getMetricasPrincipales(data.metricasAdicionales[key])[0].ejecucion) * 100">
                      {{ calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[0].meta,
                      getMetricasPrincipales(data.metricasAdicionales[key])[0].ejecucion) | percent:'1.2-2' }}
                    </div>
                  </div>

                  <div class="programa-values">
                    <div class="value-item">
                      <span class="value-label">Meta:</span>
                      <span class="value-number">{{ getMetricasPrincipales(data.metricasAdicionales[key])[0].meta |
                        number:(getMetricasPrincipales(data.metricasAdicionales[key])[0].tipoDato === 'porcentaje' ?
                        '1.2-2' : '1.0-0') }}</span>
                    </div>
                    <div class="value-item">
                      <span class="value-label">Ejecutado:</span>
                      <span class="value-number">{{ getMetricasPrincipales(data.metricasAdicionales[key])[0].ejecucion |
                        number:(getMetricasPrincipales(data.metricasAdicionales[key])[0].tipoDato === 'porcentaje' ?
                        '1.2-2' : '1.0-0') }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- VACANTES -->
              <div class="programa-card programa-card-compacto">
                <div class="programa-card-header">
                  <h4 class="programa-title">{{ getMetricasPrincipales(data.metricasAdicionales[key])[1].nombreMetrica
                    }}</h4>
                </div>

                <div class="programa-metrics">
                  <div class="progress"
                    [class.has-overflow]="calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[1].meta, getMetricasPrincipales(data.metricasAdicionales[key])[1].ejecucion) > 1">
                    <div class="progress-bar"
                      [ngClass]="getClasePorcentaje(calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[1].meta, getMetricasPrincipales(data.metricasAdicionales[key])[1].ejecucion))"
                      [style.width.%]="calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[1].meta, getMetricasPrincipales(data.metricasAdicionales[key])[1].ejecucion) > 1 ? 100 : calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[1].meta, getMetricasPrincipales(data.metricasAdicionales[key])[1].ejecucion) * 100">
                      {{ calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[1].meta,
                      getMetricasPrincipales(data.metricasAdicionales[key])[1].ejecucion) | percent:'1.2-2' }}
                    </div>
                  </div>

                  <div class="programa-values">
                    <div class="value-item">
                      <span class="value-label">Meta:</span>
                      <span class="value-number">{{ getMetricasPrincipales(data.metricasAdicionales[key])[1].meta |
                        number:(getMetricasPrincipales(data.metricasAdicionales[key])[1].tipoDato === 'porcentaje' ?
                        '1.2-2' : '1.0-0') }}</span>
                    </div>
                    <div class="value-item">
                      <span class="value-label">Ejecutado:</span>
                      <span class="value-number">{{ getMetricasPrincipales(data.metricasAdicionales[key])[1].ejecucion |
                        number:(getMetricasPrincipales(data.metricasAdicionales[key])[1].tipoDato === 'porcentaje' ?
                        '1.2-2' : '1.0-0') }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Columna 2 y 3: TOTAL COLOCACIONES y TOTAL ORIENTADOS (lado a lado) -->
            <div class="programa-card">
              <div class="programa-card-header">
                <h4 class="programa-title">{{ getMetricasPrincipales(data.metricasAdicionales[key])[2].nombreMetrica }}
                </h4>
              </div>

              <div class="programa-metrics">
                <div class="progress"
                  [class.has-overflow]="calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[2].meta, getMetricasPrincipales(data.metricasAdicionales[key])[2].ejecucion) > 1">
                  <div class="progress-bar"
                    [ngClass]="getClasePorcentaje(calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[2].meta, getMetricasPrincipales(data.metricasAdicionales[key])[2].ejecucion))"
                    [style.width.%]="calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[2].meta, getMetricasPrincipales(data.metricasAdicionales[key])[2].ejecucion) > 1 ? 100 : calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[2].meta, getMetricasPrincipales(data.metricasAdicionales[key])[2].ejecucion) * 100">
                    {{ calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[2].meta,
                    getMetricasPrincipales(data.metricasAdicionales[key])[2].ejecucion) | percent:'1.2-2' }}
                  </div>
                </div>

                <div class="programa-values">
                  <div class="value-item">
                    <span class="value-label">Meta:</span>
                    <span class="value-number">{{ getMetricasPrincipales(data.metricasAdicionales[key])[2].meta |
                      number:(getMetricasPrincipales(data.metricasAdicionales[key])[2].tipoDato === 'porcentaje' ?
                      '1.2-2' : '1.0-0') }}</span>
                  </div>
                  <div class="value-item">
                    <span class="value-label">Ejecutado:</span>
                    <span class="value-number">{{ getMetricasPrincipales(data.metricasAdicionales[key])[2].ejecucion |
                      number:(getMetricasPrincipales(data.metricasAdicionales[key])[2].tipoDato === 'porcentaje' ?
                      '1.2-2' : '1.0-0') }}</span>
                  </div>
                </div>
              </div>

              <!-- Detalles TOTAL COLOCACIONES - SIEMPRE VISIBLES -->
              <div class="grandchildren-section"
                *ngIf="getMetricasPrincipales(data.metricasAdicionales[key])[2].esTotal === 1 && getDetallesMetrica(getMetricasPrincipales(data.metricasAdicionales[key])[2].id, data.metricasAdicionales[key]).length > 0">
                <div class="detalles-titulo">Detalles</div>

                <div class="grandchildren-grid grandchildren-grid-colocaciones">
                  <div class="grandchild-card"
                    *ngFor="let detalle of getDetallesMetrica(getMetricasPrincipales(data.metricasAdicionales[key])[2].id, data.metricasAdicionales[key]); trackBy: trackById">
                    <div class="grandchild-title">{{ detalle.nombreMetrica }}</div>

                    <!-- Mostrar barra solo si NO es TASA -->
                    <ng-container *ngIf="detalle.id !== 42">
                      <div class="mini-progress"
                        [class.has-overflow]="calcularPorcentaje(detalle.meta, detalle.ejecucion) > 1">
                        <div class="mini-progress-bar"
                          [ngClass]="getClasePorcentaje(calcularPorcentaje(detalle.meta, detalle.ejecucion))"
                          [style.width.%]="calcularPorcentaje(detalle.meta, detalle.ejecucion) > 1 ? 100 : calcularPorcentaje(detalle.meta, detalle.ejecucion) * 100">
                          {{ calcularPorcentaje(detalle.meta, detalle.ejecucion) | percent:'1.1-1' }}
                        </div>
                      </div>
                    </ng-container>

                    <!-- Para TASA solo mostrar porcentaje sin barra -->
                    <div class="tasa-valor" *ngIf="detalle.id === 42">
                      {{ calcularPorcentaje(detalle.meta, detalle.ejecucion) | percent:'1.2-2' }}
                    </div>

                    <div class="grandchild-values">
                      <div *ngIf="detalle.id !== 42"><small>Meta: {{ detalle.meta | number:(detalle.tipoDato ===
                          'porcentaje' ? '1.2-2' : '1.0-0') }}</small></div>
                      <div *ngIf="detalle.id !== 42"><small>Ejec: {{ detalle.ejecucion | number:(detalle.tipoDato ===
                          'porcentaje' ? '1.2-2' : '1.0-0') }}</small></div>

                      <!-- TASA: Mostrar como porcentaje con s√≠mbolo % -->
                      <div *ngIf="detalle.id === 42"><small>Meta: {{ detalle.meta * 100 | number:'1.2-2' }}%</small>
                      </div>
                      <div *ngIf="detalle.id === 42"><small>Ejec: {{ detalle.ejecucion * 100 | number:'1.2-2'
                          }}%</small></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Columna 3: TOTAL ORIENTADOS -->
            <div class="programa-card">
              <div class="programa-card-header">
                <h4 class="programa-title">{{ getMetricasPrincipales(data.metricasAdicionales[key])[3].nombreMetrica }}
                </h4>
              </div>

              <div class="programa-metrics">
                <div class="progress"
                  [class.has-overflow]="calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[3].meta, getMetricasPrincipales(data.metricasAdicionales[key])[3].ejecucion) > 1">
                  <div class="progress-bar"
                    [ngClass]="getClasePorcentaje(calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[3].meta, getMetricasPrincipales(data.metricasAdicionales[key])[3].ejecucion))"
                    [style.width.%]="calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[3].meta, getMetricasPrincipales(data.metricasAdicionales[key])[3].ejecucion) > 1 ? 100 : calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[3].meta, getMetricasPrincipales(data.metricasAdicionales[key])[3].ejecucion) * 100">
                    {{ calcularPorcentaje(getMetricasPrincipales(data.metricasAdicionales[key])[3].meta,
                    getMetricasPrincipales(data.metricasAdicionales[key])[3].ejecucion) | percent:'1.2-2' }}
                  </div>
                </div>

                <div class="programa-values">
                  <div class="value-item">
                    <span class="value-label">Meta:</span>
                    <span class="value-number">{{ getMetricasPrincipales(data.metricasAdicionales[key])[3].meta |
                      number:(getMetricasPrincipales(data.metricasAdicionales[key])[3].tipoDato === 'porcentaje' ?
                      '1.2-2' : '1.0-0') }}</span>
                  </div>
                  <div class="value-item">
                    <span class="value-label">Ejecutado:</span>
                    <span class="value-number">{{ getMetricasPrincipales(data.metricasAdicionales[key])[3].ejecucion |
                      number:(getMetricasPrincipales(data.metricasAdicionales[key])[3].tipoDato === 'porcentaje' ?
                      '1.2-2' : '1.0-0') }}</span>
                  </div>
                </div>
              </div>

              <!-- Detalles TOTAL ORIENTADOS - SIEMPRE VISIBLES -->
              <div class="grandchildren-section"
                *ngIf="getMetricasPrincipales(data.metricasAdicionales[key])[3].esTotal === 1 && getDetallesMetrica(getMetricasPrincipales(data.metricasAdicionales[key])[3].id, data.metricasAdicionales[key]).length > 0">
                <div class="detalles-titulo">Detalles</div>

                <div class="grandchildren-grid grandchildren-grid-orientados">
                  <div class="grandchild-card"
                    *ngFor="let detalle of getDetallesMetrica(getMetricasPrincipales(data.metricasAdicionales[key])[3].id, data.metricasAdicionales[key]); trackBy: trackById">
                    <div class="grandchild-title">{{ detalle.nombreMetrica }}</div>
                    <div class="mini-progress"
                      [class.has-overflow]="calcularPorcentaje(detalle.meta, detalle.ejecucion) > 1">
                      <div class="mini-progress-bar"
                        [ngClass]="getClasePorcentaje(calcularPorcentaje(detalle.meta, detalle.ejecucion))"
                        [style.width.%]="calcularPorcentaje(detalle.meta, detalle.ejecucion) > 1 ? 100 : calcularPorcentaje(detalle.meta, detalle.ejecucion) * 100">
                        {{ calcularPorcentaje(detalle.meta, detalle.ejecucion) | percent:'1.1-1' }}
                      </div>
                    </div>
                    <div class="grandchild-values">
                      <div><small>Meta: {{ detalle.meta | number:(detalle.tipoDato === 'porcentaje' ? '1.2-2' : '1.0-0')
                          }}</small></div>
                      <div><small>Ejec: {{ detalle.ejecucion | number:(detalle.tipoDato === 'porcentaje' ? '1.2-2' :
                          '1.0-0') }}</small></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </div>

    <!-- Secci√≥n: M√©tricas Adicionales (todas excepto AGENCIA PUBLICA) -->
    <div *ngIf="data.metricasAdicionales" class="data-section">
      <ng-container *ngFor="let key of getMetricasKeys(data.metricasAdicionales); let first = first">
        <!-- Saltar AGENCIA PUBLICA (ya se muestra arriba) -->
        <ng-container *ngIf="!first">
          <h2 class="section-title">{{ key }}</h2>

          <!-- Grid din√°mico seg√∫n cantidad de m√©tricas -->
          <div class="metricas-adicionales-grid"
            [style.grid-template-columns]="'repeat(' + getColumnasGrid(data.metricasAdicionales[key].length) + ', 1fr)'">
            <div class="programa-card" *ngFor="let metrica of data.metricasAdicionales[key]; trackBy: trackById">
              <div class="programa-card-header">
                <h4 class="programa-title">{{ metrica.nombreMetrica }}</h4>
              </div>

              <div class="programa-metrics">
                <div class="progress" [class.has-overflow]="calcularPorcentaje(metrica.meta, metrica.ejecucion) > 1">
                  <div class="progress-bar"
                    [ngClass]="getClasePorcentaje(calcularPorcentaje(metrica.meta, metrica.ejecucion))"
                    [style.width.%]="calcularPorcentaje(metrica.meta, metrica.ejecucion) > 1 ? 100 : calcularPorcentaje(metrica.meta, metrica.ejecucion) * 100">
                    {{ calcularPorcentaje(metrica.meta, metrica.ejecucion) | percent:'1.2-2' }}
                  </div>
                </div>

                <div class="programa-values">
                  <div class="value-item">
                    <span class="value-label">Meta:</span>
                    <span class="value-number">{{ metrica.meta | number:(metrica.tipoDato === 'porcentaje' ? '1.2-2' :
                      '1.0-0') }}</span>
                  </div>
                  <div class="value-item">
                    <span class="value-label">Ejecutado:</span>
                    <span class="value-number">{{ metrica.ejecucion | number:(metrica.tipoDato === 'porcentaje' ?
                      '1.2-2' : '1.0-0') }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </div>

  </div>
</div>

<!-- Plantilla Recursiva para cada Nodo de Nivel -->
<ng-template #nivelNodeTpl let-node>
  <div class="nivel-parent-card" [class.nested]="node.level > 0">
    <!-- Cabecera de la Tarjeta (Clickable) -->
    <div class="nivel-parent-header" (click)="toggleNivelNode(node)" [class.expandable]="node.children.length > 0">
      <div class="parent-title-section">
        <span class="toggle-icon" *ngIf="node.children.length > 0">
          {{ node.isCollapsed ? '‚ñ∫' : '‚ñº' }}
        </span>
        <h3 class="parent-title">{{ node.nivelFormacion }}</h3>
      </div>
      <div class="parent-metrics">
        <div class="parent-metric">
          <span class="metric-label">Meta:</span>
          <span class="metric-value-large">{{ node.totalMeta | number:'1.0-0' }}</span>
        </div>
        <div class="parent-metric">
          <span class="metric-label">Ejecuci√≥n:</span>
          <span class="metric-value-large">{{ calcularTotalEjecucion(node) | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <!-- Progress Bar Total -->
    <div class="nivel-parent-progress-section">
      <div class="progress" [class.has-overflow]="calcularPorcentaje(node.totalMeta, calcularTotalEjecucion(node)) > 1">
        <div class="progress-bar"
          [ngClass]="getClasePorcentaje(calcularPorcentaje(node.totalMeta, calcularTotalEjecucion(node)))"
          [style.width.%]="calcularPorcentaje(node.totalMeta, calcularTotalEjecucion(node)) > 1 ? 100 : calcularPorcentaje(node.totalMeta, calcularTotalEjecucion(node)) * 100">
          {{ calcularPorcentaje(node.totalMeta, calcularTotalEjecucion(node)) | percent:'1.2-2' }}
        </div>
      </div>
    </div>

    <!-- Grid de Estrategias (3 columnas) -->
    <div class="strategies-grid">
      <!-- Estrategia Regular -->
      <div class="strategy-card">
        <h4 class="strategy-title">Regular</h4>
        <div class="progress" [class.has-overflow]="calcularPorcentaje(node.regularMeta, node.regularEjecucion) > 1">
          <div class="progress-bar"
            [ngClass]="getClasePorcentaje(calcularPorcentaje(node.regularMeta, node.regularEjecucion))"
            [style.width.%]="calcularPorcentaje(node.regularMeta, node.regularEjecucion) > 1 ? 100 : calcularPorcentaje(node.regularMeta, node.regularEjecucion) * 100">
            {{ calcularPorcentaje(node.regularMeta, node.regularEjecucion) | percent:'1.1-1' }}
          </div>
        </div>
        <div class="strategy-values-compact">
          <span><strong>Meta:</strong> {{ node.regularMeta | number:'1.0-0' }}</span>
          <span class="separator">|</span>
          <span><strong>Ejec:</strong> {{ node.regularEjecucion | number:'1.0-0' }}</span>
        </div>
      </div>

      <!-- Estrategia Campesena -->
      <div class="strategy-card">
        <h4 class="strategy-title">Campesena</h4>
        <div class="progress"
          [class.has-overflow]="calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion) > 1">
          <div class="progress-bar"
            [ngClass]="getClasePorcentaje(calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion))"
            [style.width.%]="calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion) > 1 ? 100 : calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion) * 100">
            {{ calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion) | percent:'1.1-1' }}
          </div>
        </div>
        <div class="strategy-values-compact">
          <span><strong>Meta:</strong> {{ node.campesenaMeta | number:'1.0-0' }}</span>
          <span class="separator">|</span>
          <span><strong>Ejec:</strong> {{ node.campesenaEjecucion | number:'1.0-0' }}</span>
        </div>
      </div>

      <!-- Estrategia Full Popular -->
      <div class="strategy-card">
        <h4 class="strategy-title">Full Popular</h4>
        <div class="progress"
          [class.has-overflow]="calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion) > 1">
          <div class="progress-bar"
            [ngClass]="getClasePorcentaje(calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion))"
            [style.width.%]="calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion) > 1 ? 100 : calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion) * 100">
            {{ calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion) | percent:'1.1-1' }}
          </div>
        </div>
        <div class="strategy-values-compact">
          <span><strong>Meta:</strong> {{ node.fullPopularMeta | number:'1.0-0' }}</span>
          <span class="separator">|</span>
          <span><strong>Ejec:</strong> {{ node.fullPopularEjecucion | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Children (Recursiva) -->
    <div class="children-section" *ngIf="!node.isCollapsed && node.children.length > 0">
      <div *ngFor="let child of node.children; trackBy: trackById">
        <ng-container *ngTemplateOutlet="nivelNodeTpl; context: { $implicit: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Plantilla Recursiva para cada Nodo -->
<ng-template #nodeTpl let-node>
  <div class="card meta-card" [style.margin-left.rem]="node.level * 1.5">
    <!-- Cabecera de la Tarjeta (Clickable) -->
    <div class="card-header" (click)="toggleNode(node)" [class.expandable]="node.children.length > 0">
      <div class="header-content">
        <!-- Icono de Expansi√≥n -->
        <span class="toggle-icon" *ngIf="node.children.length > 0">
          {{ node.isCollapsed ? '‚ñ∫' : '‚ñº' }}
        </span>
        <!-- T√≠tulo de la Meta -->
        <span class="meta-title" [class.no-icon]="node.children.length === 0">
          {{ node.descripcion }}
        </span>
      </div>

      <!-- M√©tricas Principales -->
      <div class="header-metrics">
        <div class="metric-item percentage" [ngClass]="getClasePorcentaje(node.porcentaje / 100)">
          {{ node.porcentaje / 100 | percent:'1.2-2' }}
        </div>
        <div class="metric-item">
          <span class="metric-label">Meta:</span>
          <span class="metric-value">{{ node.meta | number:'1.0-0' }}</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Ejecuci√≥n:</span>
          <span class="metric-value">{{ node.ejecucion | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <!-- Contenedor de Hijos (Colapsable) -->
    <div class="card-body" *ngIf="!node.isCollapsed && node.children.length > 0">
      <div *ngFor="let child of node.children; trackBy: trackById">
        <ng-container *ngTemplateOutlet="nodeTpl; context: { $implicit: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Plantilla Recursiva para Jerarqu√≠a -->
<ng-template #hierarchyNodeTpl let-node>
  <div class="hierarchy-node-card" [style.margin-left.rem]="node.level * 2">
    <div class="hierarchy-node-header" (click)="toggleHierarchyNode(node)" [class.expandable]="node.children.length > 0">
      <div class="hierarchy-header-content">
        <span class="toggle-icon" *ngIf="node.children.length > 0">
          {{ node.isCollapsed ? '‚ñ∫' : '‚ñº' }}
        </span>
        <span class="hierarchy-node-title" [class.no-icon]="node.children.length === 0">
          {{ removeParentheses(node.descripcion) }}
        </span>
      </div>

      <div class="hierarchy-metrics">
        <div class="hierarchy-metric-item hierarchy-percentage" [ngClass]="getClasePorcentaje(node.porcentaje / 100)">
          {{ node.porcentaje / 100 | percent:'1.2-2' }}
        </div>
        <div class="hierarchy-metric-item">
          <span class="metric-label">Meta:</span>
          <span class="metric-value">{{ node.meta | number:'1.0-0' }}</span>
        </div>
        <div class="hierarchy-metric-item">
          <span class="metric-label">Ejecuci√≥n::</span>
          <span class="metric-value">{{ node.ejecucion | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <div class="hierarchy-node-children" *ngIf="!node.isCollapsed && node.children.length > 0">
      <div *ngFor="let child of node.children; trackBy: trackByHierarchyId">
        <ng-container *ngTemplateOutlet="hierarchyNodeTpl; context: { $implicit: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Plantilla para Formaci√≥n por Estrategia -->
<ng-template #formacionEstrategiaNodeTpl let-node>
  <div class="hierarchy-node-card" [style.margin-left.rem]="node.level * 2">
    <div class="hierarchy-node-header" (click)="toggleFormacionEstrategiaNode(node)" [class.expandable]="node.children.length > 0">
      <div class="hierarchy-header-content">
        <span class="toggle-icon" *ngIf="node.children.length > 0">
          {{ node.isCollapsed ? '‚ñ∫' : '‚ñº' }}
        </span>
        <span class="hierarchy-node-title" [class.no-icon]="node.children.length === 0">
          {{ removeParentheses(node.nivelFormacion) }}
        </span>
      </div>

      <div class="hierarchy-metrics">
        <!-- Regular -->
        <div class="hierarchy-metric-item estrategia-metric" *ngIf="node.regularMeta !== null">
          <span class="estrategia-label">Regular:</span>
          <span class="hierarchy-percentage clickable"
                [ngClass]="getClaseSemaforo(calcularPorcentaje(node.regularMeta, node.regularEjecucion))"
                (click)="showMetaEjecucionPopup('Regular', node.regularMeta, node.regularEjecucion); $event.stopPropagation()">
            {{ calcularPorcentaje(node.regularMeta, node.regularEjecucion) | percent:'1.2-2' }}
          </span>
        </div>

        <!-- CampeSENA -->
        <div class="hierarchy-metric-item estrategia-metric" *ngIf="node.campesenaMeta !== null">
          <span class="estrategia-label">CampeSENA:</span>
          <span class="hierarchy-percentage clickable"
                [ngClass]="getClaseSemaforo(calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion))"
                (click)="showMetaEjecucionPopup('CampeSENA', node.campesenaMeta, node.campesenaEjecucion); $event.stopPropagation()">
            {{ calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion) | percent:'1.2-2' }}
          </span>
        </div>

        <!-- Full Popular -->
        <div class="hierarchy-metric-item estrategia-metric" *ngIf="node.fullPopularMeta !== null">
          <span class="estrategia-label">Full Popular:</span>
          <span class="hierarchy-percentage clickable"
                [ngClass]="getClaseSemaforo(calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion))"
                (click)="showMetaEjecucionPopup('Full Popular', node.fullPopularMeta, node.fullPopularEjecucion); $event.stopPropagation()">
            {{ calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion) | percent:'1.2-2' }}
          </span>
        </div>
      </div>
    </div>

    <div class="hierarchy-node-children" *ngIf="!node.isCollapsed && node.children.length > 0">
      <div *ngFor="let child of node.children; trackBy: trackByEstrategiaId">
        <ng-container *ngTemplateOutlet="formacionEstrategiaNodeTpl; context: { $implicit: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Modal para Meta/Ejecuci√≥n -->
<div class="modal-overlay" *ngIf="showMetaEjecucionModal" (click)="closeMetaEjecucionModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modalData?.estrategia }}</h3>
      <button class="modal-close-btn" (click)="closeMetaEjecucionModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-metric">
        <span class="modal-label">Meta:</span>
        <span class="modal-value">{{ modalData?.meta | number:'1.0-0' }}</span>
      </div>
      <div class="modal-metric">
        <span class="modal-label">Ejecuci√≥n:</span>
        <span class="modal-value">{{ modalData?.ejecucion | number:'1.0-0' }}</span>
      </div>
      <div class="modal-metric">
        <span class="modal-label">Porcentaje:</span>
        <span class="modal-value" [ngClass]="getClaseSemaforo(modalData?.porcentaje || 0)">
          {{ (modalData?.porcentaje || 0) / 100 | percent:'1.2-2' }}
        </span>
      </div>
    </div>
  </div>
</div>