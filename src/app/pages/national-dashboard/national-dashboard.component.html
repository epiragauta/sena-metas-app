<!-- Indicador de Carga -->
<div *ngIf="cargando" class="loading-container">
  <div class="spinner"></div>
  <p>Cargando datos del dashboard nacional...</p>
</div>

<!-- Contenedor Principal del Dashboard -->
<div *ngIf="dashboardData$ | async as data" class="dashboard-container fade-in">

  <!-- Tabs Navigation -->
  <div class="tabs-navigation">
    <button *ngFor="let tab of tabs"
            class="tab-button"
            [class.active]="isTabActive(tab.id)"
            (click)="selectTab(tab.id)">
      <span class="tab-icon">{{ tab.icon }}</span>
      <span class="tab-label">{{ tab.label }}</span>
    </button>
  </div>

  <!-- Tab Content: FormaciÃ³n Profesional Integral -->
  <div *ngIf="isTabActive('formacion-integral')" class="tab-content fade-in">
    <!-- #################################### -->
    <!-- ##   JERARQUÃA DE METAS FPI       ## -->
    <!-- #################################### -->

    <div class="hierarchy-section">
      <div class="data-section">
        <h2 class="section-title">Metas FormaciÃ³n Profesional Integral</h2>

        <!-- Root Node (Parent) usando hierarchyRoot -->
        <div *ngIf="data.hierarchyRoot">
          <!-- Parent Card -->
          <div class="parent-card">
            <div class="parent-header" (click)="toggleHierarchyNode(data.hierarchyRoot)"
                [class.expandable]="data.hierarchyRoot.children.length > 0">
              <div class="parent-title-section">
                <span class="toggle-icon" *ngIf="data.hierarchyRoot.children.length > 0">
                  {{ data.hierarchyRoot.isCollapsed ? 'â–º' : 'â–¼' }}
                </span>
                <h3 class="parent-title">{{ removeParentheses(data.hierarchyRoot.descripcion) }}</h3>
              </div>
              <div class="parent-metrics">
                <div class="parent-metric">
                  <span class="metric-label">Meta:</span>
                  <span class="metric-value-large">{{ data.hierarchyRoot.meta | number:'1.0-0' }}</span>
                </div>
                <div class="parent-metric">
                  <span class="metric-label">EjecuciÃ³n:</span>
                  <span class="metric-value-large">{{ data.hierarchyRoot.ejecucion | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="parent-progress-section">
              <div class="progress" [class.has-overflow]="data.hierarchyRoot.porcentaje > 100">
                <div class="progress-bar" [ngClass]="getClasePorcentaje(data.hierarchyRoot.porcentaje / 100)"
                  [style.width.%]="data.hierarchyRoot.porcentaje > 100 ? 100 : data.hierarchyRoot.porcentaje">
                  {{ data.hierarchyRoot.porcentaje / 100 | percent:'1.2-2' }}
                </div>
              </div>
            </div>

            <!-- Children Cards (Horizontal Layout) - Solo segundo nivel -->
            <div class="children-cards-grid" *ngIf="!data.hierarchyRoot.isCollapsed && data.hierarchyRoot.children.length > 0">
              <div class="child-card"
                  *ngFor="let child of getSecondLevelChildren(data.hierarchyRoot); trackBy: trackByHierarchyId"
                  [class.child-card-selected]="isNodeSelectedForTree(child)"
                  (click)="selectNodeForTree(child)">
                <div class="child-card-header">
                  <h4 class="child-title">{{ removeParentheses(child.descripcion) }}</h4>
                </div>

                <div class="child-metrics">
                  <div class="progress" [class.has-overflow]="child.porcentaje > 100">
                    <div class="progress-bar" [ngClass]="getClasePorcentaje(child.porcentaje / 100)"
                      [style.width.%]="child.porcentaje > 100 ? 100 : child.porcentaje">
                      {{ child.porcentaje / 100 | percent:'1.2-2' }}
                    </div>
                  </div>

                  <div class="child-values">
                    <div class="value-item">
                      <span class="value-label">Meta:</span>
                      <span class="value-number">{{ child.meta | number:'1.0-0' }}</span>
                    </div>
                    <div class="value-item">
                      <span class="value-label">EjecuciÃ³n:</span>
                      <span class="value-number">{{ child.ejecucion | number:'1.0-0' }}</span>
                    </div>
                  </div>
                </div>

                <!-- Indicador de hijos disponibles -->
                <div class="child-has-details" *ngIf="child.children.length > 0">
                  <span class="details-icon">ðŸ“Š</span>
                  <span class="details-text">Click para ver detalles ({{ child.children.length }} Ã­tems)</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de Ãrbol para nodo seleccionado -->
      <div *ngIf="selectedNodeForTree" class="data-section selected-node-tree-section">
        <div class="selected-node-header">
          <h2 class="section-title">{{ removeParentheses(selectedNodeForTree.descripcion) }}</h2>
          <button class="close-tree-btn" (click)="selectedNodeForTree = null">âœ• Cerrar</button>
        </div>

        <!-- Mostrar solo los hijos, no el nodo padre -->
        <div class="children-tree-container" *ngIf="selectedNodeForTree.children.length > 0">
          <div *ngFor="let child of selectedNodeForTree.children; trackBy: trackByHierarchyId">
            <ng-container *ngTemplateOutlet="hierarchyNodeTpl; context: { $implicit: child }"></ng-container>
          </div>
        </div>
        <div class="no-children-message" *ngIf="selectedNodeForTree.children.length === 0">
          <p>No hay elementos de detalle para mostrar.</p>
        </div>
      </div>
    </div>


    <!-- #################################### -->
    <!-- ##      SECCIONES ADICIONALES     ## -->
    <!-- #################################### -->
    <div class="additional-sections">
      <!-- SecciÃ³n: FormaciÃ³n por Estrategia -->
      <div *ngIf="data.formacionEstrategiaRoot" class="data-section">
        <h2 class="section-title">Metas por Estrategias de FormaciÃ³n</h2>

        <!-- Tarjetas Directas (sin tarjeta padre, solo las hijas) -->
        <div class="children-cards-grid">
          <div class="child-card estrategia-child-card"
              *ngFor="let child of data.formacionEstrategiaRoot.children; trackBy: trackByEstrategiaId"
              [class.child-card-selected]="isEstrategiaNodeSelectedForTree(child)"
              (click)="selectEstrategiaNodeForTree(child)">
            <div class="child-card-header">
              <h4 class="child-title">{{ removeParentheses(child.nivelFormacion) }}</h4>
            </div>

            <!-- Grid de Estrategias con meta/ejecuciÃ³n explÃ­cita -->
            <div class="estrategias-grid-explicit">
              <!-- Regular -->
              <div class="estrategia-explicit-item" *ngIf="child.regularMeta !== null">
                <h5 class="estrategia-explicit-label">Regular</h5>
                <div class="progress" [class.has-overflow]="calcularPorcentaje(child.regularMeta, child.regularEjecucion) > 1">
                  <div class="progress-bar"
                      [ngClass]="getClasePorcentaje(calcularPorcentaje(child.regularMeta, child.regularEjecucion))"
                      [style.width.%]="calcularPorcentaje(child.regularMeta, child.regularEjecucion) > 1 ? 100 : calcularPorcentaje(child.regularMeta, child.regularEjecucion) * 100">
                    {{ calcularPorcentaje(child.regularMeta, child.regularEjecucion) | percent:'1.2-2' }}
                  </div>
                </div>
                <div class="estrategia-explicit-values">
                  <div class="value-item">
                    <span class="value-label">Meta:</span>
                    <span class="value-number">{{ child.regularMeta | number:'1.0-0' }}</span>
                  </div>
                  <div class="value-item">
                    <span class="value-label">EjecuciÃ³n:</span>
                    <span class="value-number">{{ child.regularEjecucion | number:'1.0-0' }}</span>
                  </div>
                </div>
              </div>

              <!-- CampeSENA -->
              <div class="estrategia-explicit-item" *ngIf="child.campesenaMeta !== null">
                <h5 class="estrategia-explicit-label">CampeSENA</h5>
                <div class="progress" [class.has-overflow]="calcularPorcentaje(child.campesenaMeta, child.campesenaEjecucion) > 1">
                  <div class="progress-bar"
                      [ngClass]="getClasePorcentaje(calcularPorcentaje(child.campesenaMeta, child.campesenaEjecucion))"
                      [style.width.%]="calcularPorcentaje(child.campesenaMeta, child.campesenaEjecucion) > 1 ? 100 : calcularPorcentaje(child.campesenaMeta, child.campesenaEjecucion) * 100">
                    {{ calcularPorcentaje(child.campesenaMeta, child.campesenaEjecucion) | percent:'1.2-2' }}
                  </div>
                </div>
                <div class="estrategia-explicit-values">
                  <div class="value-item">
                    <span class="value-label">Meta:</span>
                    <span class="value-number">{{ child.campesenaMeta | number:'1.0-0' }}</span>
                  </div>
                  <div class="value-item">
                    <span class="value-label">EjecuciÃ³n:</span>
                    <span class="value-number">{{ child.campesenaEjecucion | number:'1.0-0' }}</span>
                  </div>
                </div>
              </div>

              <!-- Full Popular -->
              <div class="estrategia-explicit-item" *ngIf="child.fullPopularMeta !== null">
                <h5 class="estrategia-explicit-label">Full Popular</h5>
                <div class="progress" [class.has-overflow]="calcularPorcentaje(child.fullPopularMeta, child.fullPopularEjecucion) > 1">
                  <div class="progress-bar"
                      [ngClass]="getClasePorcentaje(calcularPorcentaje(child.fullPopularMeta, child.fullPopularEjecucion))"
                      [style.width.%]="calcularPorcentaje(child.fullPopularMeta, child.fullPopularEjecucion) > 1 ? 100 : calcularPorcentaje(child.fullPopularMeta, child.fullPopularEjecucion) * 100">
                    {{ calcularPorcentaje(child.fullPopularMeta, child.fullPopularEjecucion) | percent:'1.2-2' }}
                  </div>
                </div>
                <div class="estrategia-explicit-values">
                  <div class="value-item">
                    <span class="value-label">Meta:</span>
                    <span class="value-number">{{ child.fullPopularMeta | number:'1.0-0' }}</span>
                  </div>
                  <div class="value-item">
                    <span class="value-label">EjecuciÃ³n:</span>
                    <span class="value-number">{{ child.fullPopularEjecucion | number:'1.0-0' }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Indicador de hijos disponibles -->
            <div class="child-has-details" *ngIf="child.children.length > 0">
              <span class="details-icon">ðŸ“Š</span>
              <span class="details-text">Click para ver detalles ({{ child.children.length }} Ã­tems)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de Estrategias para nodo seleccionado -->
      <div *ngIf="selectedEstrategiaNodeForTree" class="data-section selected-node-tree-section">
        <div class="selected-node-header">
          <h2 class="section-title">{{ removeParentheses(selectedEstrategiaNodeForTree.nivelFormacion) }}</h2>
          <button class="close-tree-btn" (click)="selectedEstrategiaNodeForTree = null">âœ• Cerrar</button>
        </div>

        <!-- Mostrar solo los hijos, no el nodo padre -->
        <div class="children-tree-container" *ngIf="selectedEstrategiaNodeForTree.children.length > 0">
          <div *ngFor="let child of selectedEstrategiaNodeForTree.children; trackBy: trackByEstrategiaId">
            <ng-container *ngTemplateOutlet="formacionEstrategiaNodeTpl; context: { $implicit: child }"></ng-container>
          </div>
        </div>
        <div class="no-children-message" *ngIf="selectedEstrategiaNodeForTree.children.length === 0">
          <p>No hay elementos de detalle para mostrar.</p>
        </div>
      </div>

      <!-- SecciÃ³n: Metas Programas Relevantes y Primer Curso -->
      <div *ngIf="(data.programasRelevantes && data.programasRelevantes.length > 0) || data.metasPrimerCurso" class="data-section">
        <h2 class="section-title">Metas Programas Relevantes y Primer Curso</h2>

        <div class="programas-primer-curso-layout">
          <!-- Lado izquierdo: Programas Relevantes -->
          <div class="programas-section" *ngIf="data.programasRelevantes && data.programasRelevantes.length > 0">
            <h3 class="subsection-title">Programas Relevantes</h3>

            <!-- Grid de 3 Programas -->
            <div class="programas-grid">
              <div class="programa-card" *ngFor="let programa of data.programasRelevantes; trackBy: trackById">
                <div class="programa-card-header">
                  <h4 class="programa-title">{{ programa.descripcion }}</h4>
                </div>

                <div class="programa-metrics">
                  <div class="progress" [class.has-overflow]="programa.porcentaje > 100">
                    <div class="progress-bar" [ngClass]="getClasePorcentaje(programa.porcentaje / 100)"
                      [style.width.%]="programa.porcentaje > 100 ? 100 : programa.porcentaje">
                      {{ programa.porcentaje / 100 | percent:'1.2-2' }}
                    </div>
                  </div>

                  <div class="programa-values">
                    <div class="value-item">
                      <span class="value-label">Meta:</span>
                      <span class="value-number">{{ programa.meta | number:'1.0-0' }}</span>
                    </div>
                    <div class="value-item">
                      <span class="value-label">Ejecutado:</span>
                      <span class="value-number">{{ programa.ejecucion | number:'1.0-0' }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Lado derecho: Primer Curso -->
          <div class="primer-curso-section" *ngIf="data.metasPrimerCurso">
            <h3 class="subsection-title">Primer Curso</h3>

            <!-- Tarjeta de Primer Curso -->
            <div class="primer-curso-card">
              <div class="primer-curso-header">
                <h4 class="primer-curso-title">{{ data.metasPrimerCurso.descripcion }}</h4>
              </div>

              <div class="primer-curso-metrics">
                <div class="progress" [class.has-overflow]="data.metasPrimerCurso.porcentaje > 100">
                  <div class="progress-bar" [ngClass]="getClasePorcentaje(data.metasPrimerCurso.porcentaje / 100)"
                      [style.width.%]="data.metasPrimerCurso.porcentaje > 100 ? 100 : data.metasPrimerCurso.porcentaje">
                    {{ data.metasPrimerCurso.porcentaje / 100 | percent:'1.2-2' }}
                  </div>
                </div>

                <div class="primer-curso-values">
                  <div class="value-item-large">
                    <span class="value-label">Meta:</span>
                    <span class="value-number-large">{{ data.metasPrimerCurso.meta | number:'1.0-0' }}</span>
                  </div>
                  <div class="value-item-large">
                    <span class="value-label">Ejecutado:</span>
                    <span class="value-number-large">{{ data.metasPrimerCurso.ejecucion | number:'1.0-0' }}</span>
                  </div>
                </div>
              </div>
            </div>
        </div>
      </div>
      </div>
    </div>

    <!-- End Tab Content: FormaciÃ³n Profesional Integral -->
  </div>

  <!-- Tab Content: CertificaciÃ³n y RetenciÃ³n -->
  <div *ngIf="isTabActive('certificacion-retencion')" class="tab-content fade-in">
    
    <!-- Debug: Mostrar si no hay datos -->
    <div *ngIf="!data.retencionPadres && !data.certificacionRoot && !data.competenciasLaboralesRoot" class="data-section">
      <p style="text-align: center; padding: 2rem; color: #666;">No hay datos disponibles para esta secciÃ³n.</p>
    </div>

    <!-- RETENCIÃ“N -->
    <div *ngIf="data.retencionPadres && data.retencionPadres.length > 0" class="data-section">
      <h2 class="section-title">RetenciÃ³n</h2>

        <div class="retencion-layout">
          <!-- Primera columna: indicadores 1-6 en grid 3 columnas -->
          <div class="retencion-column-1">
            <div class="retencion-grid-3col">
              <div class="programa-card retencion-card"
                   *ngFor="let node of data.retencionPadres.slice(0, 6); trackBy: trackByHierarchyId"
                   [class.retencion-card-selected]="isRetencionNodeSelected(node)"
                   (click)="selectRetencionNode(node)">
                <div class="programa-card-header">
                  <h4 class="programa-title">{{ node.descripcion }}</h4>
                </div>

                <div class="programa-metrics">
                  <div class="progress" [class.has-overflow]="node.porcentaje > 100">
                    <div class="progress-bar progress-bar-gray"
                      [style.width.%]="node.porcentaje > 100 ? 100 : node.porcentaje">
                      {{ node.porcentaje / 100 | percent:'1.2-2' }}
                    </div>
                  </div>

                  <div class="programa-values">
                    <div class="value-item">
                      <span class="value-label">Meta:</span>
                      <span class="value-number">{{ node.meta }}%</span>
                    </div>
                    <div class="value-item">
                      <span class="value-label">Ejecutado:</span>
                      <span class="value-number">{{ node.ejecucion }}%</span>
                    </div>
                  </div>
                </div>

                <div class="child-has-details" *ngIf="node.children.length > 0">
                  <span class="details-icon">ðŸ“Š</span>
                  <span class="details-text">Ver detalles ({{ node.children.length }} Ã­tems)</span>
                </div>
              </div>
            </div>

            <!-- Tabla de detalles debajo de la tarjeta seleccionada (columna 1) -->
            <div *ngIf="selectedRetencionNode && getRetencionColumnIndex(selectedRetencionNode) === 0"
                 class="retencion-detalle-table">
              <div class="detalle-header">
                <h4 class="detalle-title">{{ selectedRetencionNode.descripcion }}</h4>
                <button class="close-detalle-btn" (click)="selectedRetencionNode = null">âœ•</button>
              </div>

              <table class="table-compacta" *ngIf="selectedRetencionNode.children.length > 0">
                <thead>
                  <tr>
                    <th>DescripciÃ³n</th>
                    <th>Meta</th>
                    <th>EjecuciÃ³n</th>
                    <th>% EjecuciÃ³n</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let child of selectedRetencionNode.children; trackBy: trackByHierarchyId">
                    <td>{{ child.descripcion }}</td>
                    <td>{{ child.meta }}%</td>
                    <td>{{ child.ejecucion }}%</td>
                    <td>{{ child.porcentaje / 100 | percent:'1.2-2' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Segunda columna: indicadores 7-8 en grid 1 columna -->
          <div class="retencion-column-2">
            <div class="retencion-grid-1col">
              <div class="programa-card retencion-card retencion-card-col2"
                   *ngFor="let node of data.retencionPadres.slice(6, 8); trackBy: trackByHierarchyId">
                <div class="programa-card-header">
                  <h4 class="programa-title">{{ node.descripcion }}</h4>
                </div>

                <div class="programa-metrics">
                  <div class="progress" [class.has-overflow]="node.porcentaje > 100">
                    <div class="progress-bar progress-bar-gray"
                      [style.width.%]="node.porcentaje > 100 ? 100 : node.porcentaje">
                      {{ node.porcentaje / 100 | percent:'1.2-2' }}
                    </div>
                  </div>

                  <div class="programa-values">
                    <div class="value-item">
                      <span class="value-label">Meta:</span>
                      <span class="value-number">{{ node.meta }}%</span>
                    </div>
                    <div class="value-item">
                      <span class="value-label">Ejecutado:</span>
                      <span class="value-number">{{ node.ejecucion }}%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>

    <!-- CERTIFICACIÃ“N FORMACIÃ“N PROFESIONAL-->
    <div *ngIf="data.certificacionRoot" class="data-section">
      <h2 class="section-title">CertificaciÃ³n FormaciÃ³n Profesional</h2>

        <!-- Una sola fila con 4 elementos: ID=1, ID=2, ID=3, ID=4 -->
        <div class="certificacion-grid-4col" *ngIf="data.certificacionTree">
          <!-- Tarjeta 1: ID=1 (TOTAL FORMACIÃ“N PROFESIONAL INTEGRAL) con botÃ³n de detalles -->
          <div class="programa-card certificacion-card"
               [class.child-card-selected]="isCertificacionNodeSelected(data.certificacionRoot)"
               (click)="selectCertificacionNode(data.certificacionRoot)">
            <div class="programa-card-header">
              <h4 class="programa-title">{{ data.certificacionRoot.descripcion }}</h4>
            </div>

            <div class="programa-metrics">
              <div class="progress" [class.has-overflow]="data.certificacionRoot.porcentaje > 100">
                <div class="progress-bar" [ngClass]="getClasePorcentaje(data.certificacionRoot.porcentaje / 100)"
                  [style.width.%]="data.certificacionRoot.porcentaje > 100 ? 100 : data.certificacionRoot.porcentaje">
                  {{ data.certificacionRoot.porcentaje / 100 | percent:'1.2-2' }}
                </div>
              </div>

              <div class="programa-values">
                <div class="value-item">
                  <span class="value-label">Meta:</span>
                  <span class="value-number">{{ data.certificacionRoot.meta | number:'1.0-0' }}</span>
                </div>
                <div class="value-item">
                  <span class="value-label">Ejecutado:</span>
                  <span class="value-number">{{ data.certificacionRoot.ejecucion | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>

            <div class="child-has-details" *ngIf="data.certificacionRoot.children.length > 0">
              <span class="details-icon">ðŸ“Š</span>
              <span class="details-text">Ver detalles ({{ data.certificacionRoot.children.length }} Ã­tems)</span>
            </div>
          </div>

          <!-- Tarjetas 2, 3, 4: IDs 2, 3, 4 sin botÃ³n de detalles -->
          <div class="programa-card certificacion-card"
               *ngFor="let node of data.certificacionTree.slice(1, 4); trackBy: trackByHierarchyId">
            <div class="programa-card-header">
              <h4 class="programa-title">{{ node.descripcion }}</h4>
            </div>

            <div class="programa-metrics">
              <div class="progress" [class.has-overflow]="node.porcentaje > 100">
                <div class="progress-bar" [ngClass]="getClasePorcentaje(node.porcentaje / 100)"
                  [style.width.%]="node.porcentaje > 100 ? 100 : node.porcentaje">
                  {{ node.porcentaje / 100 | percent:'1.2-2' }}
                </div>
              </div>

              <div class="programa-values">
                <div class="value-item">
                  <span class="value-label">Meta:</span>
                  <span class="value-number">{{ node.meta | number:'1.0-0' }}</span>
                </div>
                <div class="value-item">
                  <span class="value-label">Ejecutado:</span>
                  <span class="value-number">{{ node.ejecucion | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>

            <!-- Espaciador para mantener misma altura que tarjeta con botÃ³n -->
            <div class="certificacion-spacer"></div>
          </div>
        </div>

        <!-- Tabla de detalles para certificaciÃ³n con 3 niveles (estilo tree-table) -->
        <div *ngIf="selectedCertificacionNode" class="data-section selected-node-tree-section">
          <div class="selected-node-header">
            <h2 class="section-title">{{ selectedCertificacionNode.descripcion }}</h2>
            <button class="close-tree-btn" (click)="selectedCertificacionNode = null">âœ• Cerrar</button>
          </div>

          <!-- Mostrar hijos usando el template recursivo -->
          <div class="children-tree-container" *ngIf="selectedCertificacionNode.children.length > 0">
            <div *ngFor="let child of selectedCertificacionNode.children; trackBy: trackByHierarchyId">
              <ng-container *ngTemplateOutlet="certificacionNodeTpl; context: { $implicit: child }"></ng-container>
            </div>
          </div>
          <div class="no-children-message" *ngIf="selectedCertificacionNode.children.length === 0">
            <p>No hay elementos de detalle para mostrar.</p>
          </div>
        </div>
    </div>

    <!-- CERTIFICACIÃ“N DE COMPETENCIAS LABORALES -->
    <div *ngIf="data.competenciasLaboralesRoot && data.competenciasLaboralesOtros" class="data-section">
      <h2 class="section-title">CertificaciÃ³n de competencias laborales</h2>

        <!-- Fila 1: ID=1 con botÃ³n Ver detalles -->
        <div class="competencias-laborales-row-1">
          <div class="programa-card"
               [class.child-card-selected]="showCompetenciasLaboralesDetails"
               (click)="toggleCompetenciasLaboralesDetails()">
            <div class="programa-card-header">
              <h4 class="programa-title">{{ data.competenciasLaboralesRoot.descripcion }}</h4>
            </div>

            <div class="programa-metrics">
              <div class="progress" [class.has-overflow]="data.competenciasLaboralesRoot.porcentaje > 100">
                <div class="progress-bar" [ngClass]="getClasePorcentaje(data.competenciasLaboralesRoot.porcentaje / 100)"
                  [style.width.%]="data.competenciasLaboralesRoot.porcentaje > 100 ? 100 : data.competenciasLaboralesRoot.porcentaje">
                  {{ data.competenciasLaboralesRoot.porcentaje / 100 | percent:'1.2-2' }}
                </div>
              </div>

              <div class="programa-values">
                <div class="value-item">
                  <span class="value-label">Meta:</span>
                  <span class="value-number">{{ data.competenciasLaboralesRoot.meta | number:'1.0-0' }}</span>
                </div>
                <div class="value-item">
                  <span class="value-label">Ejecutado:</span>
                  <span class="value-number">{{ data.competenciasLaboralesRoot.ejecucion | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>

            <div class="child-has-details" *ngIf="data.competenciasLaboralesRoot.children.length > 0">
              <span class="details-icon">ðŸ“Š</span>
              <span class="details-text">Ver detalles ({{ data.competenciasLaboralesRoot.children.length }} Ã­tems)</span>
            </div>
          </div>
        </div>

        <!-- Fila 2: IDs 1.1, 1.2, 1.3 (solo visible si showCompetenciasLaboralesDetails es true) -->
        <div *ngIf="showCompetenciasLaboralesDetails" class="competencias-laborales-row-2">
          <div class="competencias-laborales-grid-3col">
            <div class="programa-card"
                 *ngFor="let node of data.competenciasLaboralesRoot.children; trackBy: trackByHierarchyId">
              <div class="programa-card-header">
                <h4 class="programa-title">{{ node.descripcion }}</h4>
              </div>

              <div class="programa-metrics">
                <div class="progress" [class.has-overflow]="node.porcentaje > 100">
                  <div class="progress-bar" [ngClass]="getClasePorcentaje(node.porcentaje / 100)"
                    [style.width.%]="node.porcentaje > 100 ? 100 : node.porcentaje">
                    {{ node.porcentaje / 100 | percent:'1.2-2' }}
                  </div>
                </div>

                <div class="programa-values">
                  <div class="value-item">
                    <span class="value-label">Meta:</span>
                    <span class="value-number">{{ node.meta | number:'1.0-0' }}</span>
                  </div>
                  <div class="value-item">
                    <span class="value-label">Ejecutado:</span>
                    <span class="value-number">{{ node.ejecucion | number:'1.0-0' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Fila 3: IDs 2, 3, 4 -->
        <div class="competencias-laborales-row-3">
          <div class="competencias-laborales-grid-3col">
            <div class="programa-card"
                 *ngFor="let node of data.competenciasLaboralesOtros.slice(0, 3); trackBy: trackByHierarchyId">
              <div class="programa-card-header">
                <h4 class="programa-title">{{ node.descripcion }}</h4>
              </div>

              <div class="programa-metrics">
                <div class="progress" [class.has-overflow]="node.porcentaje > 100">
                  <div class="progress-bar" [ngClass]="getClasePorcentaje(node.porcentaje / 100)"
                    [style.width.%]="node.porcentaje > 100 ? 100 : node.porcentaje">
                    {{ node.porcentaje / 100 | percent:'1.2-2' }}
                  </div>
                </div>

                <div class="programa-values">
                  <div class="value-item">
                    <span class="value-label">Meta:</span>
                    <span class="value-number">{{ node.meta | number:'1.0-0' }}</span>
                  </div>
                  <div class="value-item">
                    <span class="value-label">Ejecutado:</span>
                    <span class="value-number">{{ node.ejecucion | number:'1.0-0' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Fila 4: IDs 5, 6, 7 -->
        <div class="competencias-laborales-row-4">
          <div class="competencias-laborales-grid-3col">
            <div class="programa-card"
                 *ngFor="let node of data.competenciasLaboralesOtros.slice(3, 6); trackBy: trackByHierarchyId">
              <div class="programa-card-header">
                <h4 class="programa-title">{{ node.descripcion }}</h4>
              </div>

              <div class="programa-metrics">
                <div class="progress" [class.has-overflow]="node.porcentaje > 100">
                  <div class="progress-bar" [ngClass]="getClasePorcentaje(node.porcentaje / 100)"
                    [style.width.%]="node.porcentaje > 100 ? 100 : node.porcentaje">
                    {{ node.porcentaje / 100 | percent:'1.2-2' }}
                  </div>
                </div>

                <div class="programa-values">
                  <div class="value-item">
                    <span class="value-label">Meta:</span>
                    <span class="value-number">{{ node.meta | number:'1.0-0' }}</span>
                  </div>
                  <div class="value-item">
                    <span class="value-label">Ejecutado:</span>
                    <span class="value-number">{{ node.ejecucion | number:'1.0-0' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  </div>
  
  <!-- End Tab Content: CertificaciÃ³n y RetenciÃ³n -->

  <!-- Tab Content: Programas de InclusiÃ³n Social -->
  <div *ngIf="isTabActive('inclusion-social')" class="tab-content fade-in">
    <!-- PRODUCTIVIDAD CAMPESENA -->
    <div *ngIf="data.productividadCampesena && data.productividadCampesena.length > 0" class="data-section">
      <h2 class="section-title">Productividad CampeSENA</h2>

        <!-- Una fila con 4 tarjetas -->
        <div class="productividad-campesena-grid">
          <div class="programa-card"
               *ngFor="let node of data.productividadCampesena; trackBy: trackByHierarchyId">
            <div class="programa-card-header">
              <h4 class="programa-title">{{ node.descripcion }}</h4>
            </div>

            <div class="programa-metrics">
              <div class="progress" [class.has-overflow]="node.porcentaje > 100">
                <div class="progress-bar" [ngClass]="getClasePorcentaje(node.porcentaje / 100)"
                  [style.width.%]="node.porcentaje > 100 ? 100 : node.porcentaje">
                  {{ node.porcentaje / 100 | percent:'1.2-2' }}
                </div>
              </div>

              <div class="programa-values">
                <div class="value-item">
                  <span class="value-label">Meta:</span>
                  <span class="value-number">{{ node.meta | number:'1.0-0' }}</span>
                </div>
                <div class="value-item">
                  <span class="value-label">Ejecutado:</span>
                  <span class="value-number">{{ node.ejecucion | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>

    <!-- POBLACIONES VULNERABLES -->
    <div *ngIf="data.poblacionesVulnerablesRoot" class="data-section">
      <h2 class="section-title">Poblaciones vulnerables</h2>

        <!-- Fila 1: Tarjeta principal ID=1 con botÃ³n Ver detalles -->
        <div class="poblaciones-vulnerables-row-1">
          <div class="programa-card"
               [class.child-card-selected]="isPoblacionesVulnerablesNodeSelected(data.poblacionesVulnerablesRoot)"
               (click)="selectPoblacionesVulnerablesNode(data.poblacionesVulnerablesRoot)">
            <div class="programa-card-header">
              <h4 class="programa-title">{{ data.poblacionesVulnerablesRoot.descripcion }}</h4>
            </div>

            <div class="programa-metrics">
              <div class="progress" [class.has-overflow]="data.poblacionesVulnerablesRoot.porcentaje > 100">
                <div class="progress-bar" [ngClass]="getClasePorcentaje(data.poblacionesVulnerablesRoot.porcentaje / 100)"
                  [style.width.%]="data.poblacionesVulnerablesRoot.porcentaje > 100 ? 100 : data.poblacionesVulnerablesRoot.porcentaje">
                  {{ data.poblacionesVulnerablesRoot.porcentaje / 100 | percent:'1.2-2' }}
                </div>
              </div>

              <div class="programa-values">
                <div class="value-item">
                  <span class="value-label">Meta:</span>
                  <span class="value-number">{{ data.poblacionesVulnerablesRoot.meta | number:'1.0-0' }}</span>
                </div>
                <div class="value-item">
                  <span class="value-label">Ejecutado:</span>
                  <span class="value-number">{{ data.poblacionesVulnerablesRoot.ejecucion | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>

            <div class="child-has-details" *ngIf="data.poblacionesVulnerablesRoot.children.length > 0">
              <span class="details-icon">ðŸ“Š</span>
              <span class="details-text">Ver detalles ({{ data.poblacionesVulnerablesRoot.children.length }} Ã­tems)</span>
            </div>
          </div>
        </div>

        <!-- Fila 2: Tree-table con detalles (visible al hacer clic) -->
        <div *ngIf="selectedPoblacionesVulnerablesNode" class="data-section selected-node-tree-section">
          <div class="selected-node-header">
            <h2 class="section-title">{{ selectedPoblacionesVulnerablesNode.descripcion }}</h2>
            <button class="close-tree-btn" (click)="selectedPoblacionesVulnerablesNode = null">âœ• Cerrar</button>
          </div>

          <!-- Mostrar hijos usando el template recursivo -->
          <div class="children-tree-container" *ngIf="selectedPoblacionesVulnerablesNode.children.length > 0">
            <div *ngFor="let child of selectedPoblacionesVulnerablesNode.children; trackBy: trackByHierarchyId">
              <ng-container *ngTemplateOutlet="poblacionesVulnerablesNodeTpl; context: { $implicit: child }"></ng-container>
            </div>
          </div>
          <div class="no-children-message" *ngIf="selectedPoblacionesVulnerablesNode.children.length === 0">
            <p>No hay elementos de detalle para mostrar.</p>
          </div>
        </div>
    </div>
  </div>
  <!-- End Tab Content: Programas de InclusiÃ³n Social -->

  <!-- Tab Content: Servicios de Empleo -->
  <div *ngIf="isTabActive('servicios-empleo')" class="tab-content fade-in">
    <!-- AGENCIA PÃšBLICA DE EMPLEO -->
    <div *ngIf="data.agenciaPublicaEmpleoNivel1 && data.agenciaPublicaEmpleoNivel1.length > 0" class="data-section">
      <h2 class="section-title">Agencia pÃºblica de empleo</h2>

        <!-- Fila 1: 5 tarjetas de nivel 1 (IDs 1, 2, 3, 4, 5) -->
        <div class="agencia-publica-empleo-grid">
          <div *ngFor="let node of data.agenciaPublicaEmpleoNivel1; trackBy: trackByHierarchyId"
               class="programa-card"
               [class.child-card-selected]="isAgenciaPublicaEmpleoNodeSelected(node) && node.children.length > 0"
               [class.clickable]="node.children.length > 0"
               (click)="node.children.length > 0 ? selectAgenciaPublicaEmpleoNode(node) : null">
            <div class="programa-card-header">
              <h4 class="programa-title">{{ node.descripcion }}</h4>
            </div>

            <div class="programa-metrics">
              <div class="progress" [class.has-overflow]="node.porcentaje > 100">
                <div class="progress-bar" [ngClass]="getClasePorcentaje(node.porcentaje / 100)"
                  [style.width.%]="node.porcentaje > 100 ? 100 : node.porcentaje">
                  {{ node.id === '5' ? (node.ejecucion / 100 | percent:'1.2-2') : (node.porcentaje / 100 | percent:'1.2-2') }}
                </div>
              </div>

              <div class="programa-values">
                <div class="value-item">
                  <span class="value-label">Meta:</span>
                  <span class="value-number">{{ node.id === '5' ? (node.meta / 100 | percent:'1.0-0') : (node.meta | number:'1.0-0') }}</span>
                </div>
                <div class="value-item">
                  <span class="value-label">Ejecutado:</span>
                  <span class="value-number">{{ node.id === '5' ? (node.ejecucion / 100 | percent:'1.2-2') : (node.ejecucion | number:'1.0-0') }}</span>
                </div>
              </div>
            </div>

            <div class="child-has-details" *ngIf="node.children.length > 0">
              <span class="details-icon">ðŸ“Š</span>
              <span class="details-text">Ver detalles ({{ node.children.length }} Ã­tems)</span>
            </div>
          </div>
        </div>

        <!-- Fila 2: Tarjetas hijas (visible al hacer clic) -->
        <div *ngIf="selectedAgenciaPublicaEmpleoNode && selectedAgenciaPublicaEmpleoNode.children.length > 0"
             class="agencia-publica-empleo-children-row">
          <div class="agencia-publica-empleo-children-grid">
            <div *ngFor="let child of selectedAgenciaPublicaEmpleoNode.children; trackBy: trackByHierarchyId"
                 class="programa-card child-card">
              <div class="programa-card-header">
                <h4 class="programa-title">{{ child.descripcion }}</h4>
              </div>

              <div class="programa-metrics">
                <div class="progress" [class.has-overflow]="child.porcentaje > 100">
                  <div class="progress-bar" [ngClass]="getClasePorcentaje(child.porcentaje / 100)"
                    [style.width.%]="child.porcentaje > 100 ? 100 : child.porcentaje">
                    {{ child.porcentaje / 100 | percent:'1.2-2' }}
                  </div>
                </div>

                <div class="programa-values">
                  <div class="value-item">
                    <span class="value-label">Meta:</span>
                    <span class="value-number">{{ child.meta | number:'1.0-0' }}</span>
                  </div>
                  <div class="value-item">
                    <span class="value-label">Ejecutado:</span>
                    <span class="value-number">{{ child.ejecucion | number:'1.0-0' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
  </div>
  <!-- End Tab Content: Servicios de Empleo -->

</div>
<!-- End Dashboard Container -->

<!-- Plantilla Recursiva para cada Nodo de Nivel -->
<ng-template #nivelNodeTpl let-node>
  <div class="nivel-parent-card" [class.nested]="node.level > 0">
    <!-- Cabecera de la Tarjeta (Clickable) -->
    <div class="nivel-parent-header" (click)="toggleNivelNode(node)" [class.expandable]="node.children.length > 0">
      <div class="parent-title-section">
        <span class="toggle-icon" *ngIf="node.children.length > 0">
          {{ node.isCollapsed ? 'â–º' : 'â–¼' }}
        </span>
        <h3 class="parent-title">{{ node.nivelFormacion }}</h3>
      </div>
      <div class="parent-metrics">
        <div class="parent-metric">
          <span class="metric-label">Meta:</span>
          <span class="metric-value-large">{{ node.totalMeta | number:'1.0-0' }}</span>
        </div>
        <div class="parent-metric">
          <span class="metric-label">EjecuciÃ³n:</span>
          <span class="metric-value-large">{{ calcularTotalEjecucion(node) | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <!-- Progress Bar Total -->
    <div class="nivel-parent-progress-section">
      <div class="progress" [class.has-overflow]="calcularPorcentaje(node.totalMeta, calcularTotalEjecucion(node)) > 1">
        <div class="progress-bar"
          [ngClass]="getClasePorcentaje(calcularPorcentaje(node.totalMeta, calcularTotalEjecucion(node)))"
          [style.width.%]="calcularPorcentaje(node.totalMeta, calcularTotalEjecucion(node)) > 1 ? 100 : calcularPorcentaje(node.totalMeta, calcularTotalEjecucion(node)) * 100">
          {{ calcularPorcentaje(node.totalMeta, calcularTotalEjecucion(node)) | percent:'1.2-2' }}
        </div>
      </div>
    </div>

    <!-- Grid de Estrategias (3 columnas) -->
    <div class="strategies-grid">
      <!-- Estrategia Regular -->
      <div class="strategy-card">
        <h4 class="strategy-title">Regular</h4>
        <div class="progress" [class.has-overflow]="calcularPorcentaje(node.regularMeta, node.regularEjecucion) > 1">
          <div class="progress-bar"
            [ngClass]="getClasePorcentaje(calcularPorcentaje(node.regularMeta, node.regularEjecucion))"
            [style.width.%]="calcularPorcentaje(node.regularMeta, node.regularEjecucion) > 1 ? 100 : calcularPorcentaje(node.regularMeta, node.regularEjecucion) * 100">
            {{ calcularPorcentaje(node.regularMeta, node.regularEjecucion) | percent:'1.1-1' }}
          </div>
        </div>
        <div class="strategy-values-compact">
          <span><strong>Meta:</strong> {{ node.regularMeta | number:'1.0-0' }}</span>
          <span class="separator">|</span>
          <span><strong>Ejec:</strong> {{ node.regularEjecucion | number:'1.0-0' }}</span>
        </div>
      </div>

      <!-- Estrategia Campesena -->
      <div class="strategy-card">
        <h4 class="strategy-title">Campesena</h4>
        <div class="progress"
          [class.has-overflow]="calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion) > 1">
          <div class="progress-bar"
            [ngClass]="getClasePorcentaje(calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion))"
            [style.width.%]="calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion) > 1 ? 100 : calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion) * 100">
            {{ calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion) | percent:'1.1-1' }}
          </div>
        </div>
        <div class="strategy-values-compact">
          <span><strong>Meta:</strong> {{ node.campesenaMeta | number:'1.0-0' }}</span>
          <span class="separator">|</span>
          <span><strong>Ejec:</strong> {{ node.campesenaEjecucion | number:'1.0-0' }}</span>
        </div>
      </div>

      <!-- Estrategia Full Popular -->
      <div class="strategy-card">
        <h4 class="strategy-title">Full Popular</h4>
        <div class="progress"
          [class.has-overflow]="calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion) > 1">
          <div class="progress-bar"
            [ngClass]="getClasePorcentaje(calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion))"
            [style.width.%]="calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion) > 1 ? 100 : calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion) * 100">
            {{ calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion) | percent:'1.1-1' }}
          </div>
        </div>
        <div class="strategy-values-compact">
          <span><strong>Meta:</strong> {{ node.fullPopularMeta | number:'1.0-0' }}</span>
          <span class="separator">|</span>
          <span><strong>Ejec:</strong> {{ node.fullPopularEjecucion | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <!-- SecciÃ³n de Children (Recursiva) -->
    <div class="children-section" *ngIf="!node.isCollapsed && node.children.length > 0">
      <div *ngFor="let child of node.children; trackBy: trackById">
        <ng-container *ngTemplateOutlet="nivelNodeTpl; context: { $implicit: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Plantilla Recursiva para cada Nodo -->
<ng-template #nodeTpl let-node>
  <div class="card meta-card" [style.margin-left.rem]="node.level * 1.5">
    <!-- Cabecera de la Tarjeta (Clickable) -->
    <div class="card-header" (click)="toggleNode(node)" [class.expandable]="node.children.length > 0">
      <div class="header-content">
        <!-- Icono de ExpansiÃ³n -->
        <span class="toggle-icon" *ngIf="node.children.length > 0">
          {{ node.isCollapsed ? 'â–º' : 'â–¼' }}
        </span>
        <!-- TÃ­tulo de la Meta -->
        <span class="meta-title" [class.no-icon]="node.children.length === 0">
          {{ node.descripcion }}
        </span>
      </div>

      <!-- MÃ©tricas Principales -->
      <div class="header-metrics">
        <div class="metric-item percentage" [ngClass]="getClasePorcentaje(node.porcentaje / 100)">
          {{ node.porcentaje / 100 | percent:'1.2-2' }}
        </div>
        <div class="metric-item">
          <span class="metric-label">Meta:</span>
          <span class="metric-value">{{ node.meta | number:'1.0-0' }}</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">EjecuciÃ³n:</span>
          <span class="metric-value">{{ node.ejecucion | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <!-- Contenedor de Hijos (Colapsable) -->
    <div class="card-body" *ngIf="!node.isCollapsed && node.children.length > 0">
      <div *ngFor="let child of node.children; trackBy: trackById">
        <ng-container *ngTemplateOutlet="nodeTpl; context: { $implicit: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Plantilla Recursiva para JerarquÃ­a -->
<ng-template #hierarchyNodeTpl let-node>
  <div class="hierarchy-node-card" [style.margin-left.rem]="node.level * 2">
    <div class="hierarchy-node-header" (click)="toggleHierarchyNode(node)" [class.expandable]="node.children.length > 0">
      <div class="hierarchy-header-content">
        <span class="toggle-icon" *ngIf="node.children.length > 0">
          {{ node.isCollapsed ? 'â–º' : 'â–¼' }}
        </span>
        <span class="hierarchy-node-title" [class.no-icon]="node.children.length === 0">
          {{ removeParentheses(node.descripcion) }}
        </span>
      </div>

      <div class="hierarchy-metrics">
        <div class="hierarchy-metric-item hierarchy-percentage" [ngClass]="getClasePorcentaje(node.porcentaje / 100)">
          {{ node.porcentaje / 100 | percent:'1.2-2' }}
        </div>
        <div class="hierarchy-metric-item">
          <span class="metric-label">Meta:</span>
          <span class="metric-value">{{ node.meta | number:'1.0-0' }}</span>
        </div>
        <div class="hierarchy-metric-item">
          <span class="metric-label">EjecuciÃ³n::</span>
          <span class="metric-value">{{ node.ejecucion | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <div class="hierarchy-node-children" *ngIf="!node.isCollapsed && node.children.length > 0">
      <div *ngFor="let child of node.children; trackBy: trackByHierarchyId">
        <ng-container *ngTemplateOutlet="hierarchyNodeTpl; context: { $implicit: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Plantilla recursiva para CertificaciÃ³n FormaciÃ³n Profesional -->
<ng-template #certificacionNodeTpl let-node>
  <div class="hierarchy-node-card" [style.margin-left.rem]="node.level * 2">
    <div class="hierarchy-node-header" (click)="toggleHierarchyNode(node)"
         [class.expandable]="node.children.length > 0">
      <div class="hierarchy-header-content">
        <span class="toggle-icon" *ngIf="node.children.length > 0">
          {{ node.isCollapsed ? 'â–º' : 'â–¼' }}
        </span>
        <span class="hierarchy-node-title">{{ node.descripcion }}</span>
      </div>

      <div class="hierarchy-metrics">
        <div class="hierarchy-metric-item hierarchy-percentage"
             [ngClass]="getClasePorcentaje(node.porcentaje / 100)">
          {{ node.porcentaje / 100 | percent:'1.2-2' }}
        </div>
        <div class="hierarchy-metric-item">
          <span class="metric-label">Meta:</span>
          <span class="metric-value">{{ node.meta | number:'1.0-0' }}</span>
        </div>
        <div class="hierarchy-metric-item">
          <span class="metric-label">EjecuciÃ³n:</span>
          <span class="metric-value">{{ node.ejecucion | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <div class="hierarchy-node-children" *ngIf="!node.isCollapsed && node.children.length > 0">
      <div *ngFor="let child of node.children; trackBy: trackByHierarchyId">
        <ng-container *ngTemplateOutlet="certificacionNodeTpl; context: { $implicit: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Plantilla para FormaciÃ³n por Estrategia -->
<ng-template #formacionEstrategiaNodeTpl let-node>
  <div class="hierarchy-node-card" [style.margin-left.rem]="node.level * 2">
    <div class="hierarchy-node-header" (click)="toggleFormacionEstrategiaNode(node)" [class.expandable]="node.children.length > 0">
      <div class="hierarchy-header-content">
        <span class="toggle-icon" *ngIf="node.children.length > 0">
          {{ node.isCollapsed ? 'â–º' : 'â–¼' }}
        </span>
        <span class="hierarchy-node-title" [class.no-icon]="node.children.length === 0">
          {{ removeParentheses(node.nivelFormacion) }}
        </span>
      </div>

      <div class="hierarchy-metrics">
        <!-- Regular -->
        <div class="hierarchy-metric-item estrategia-metric" *ngIf="node.regularMeta !== null">
          <span class="estrategia-label">Regular:</span>
          <span class="hierarchy-percentage clickable"
                [ngClass]="getClaseSemaforo(calcularPorcentaje(node.regularMeta, node.regularEjecucion))"
                (click)="showMetaEjecucionPopup('Regular', node.regularMeta, node.regularEjecucion); $event.stopPropagation()">
            {{ calcularPorcentaje(node.regularMeta, node.regularEjecucion) | percent:'1.2-2' }}
          </span>
        </div>

        <!-- CampeSENA -->
        <div class="hierarchy-metric-item estrategia-metric" *ngIf="node.campesenaMeta !== null">
          <span class="estrategia-label">CampeSENA:</span>
          <span class="hierarchy-percentage clickable"
                [ngClass]="getClaseSemaforo(calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion))"
                (click)="showMetaEjecucionPopup('CampeSENA', node.campesenaMeta, node.campesenaEjecucion); $event.stopPropagation()">
            {{ calcularPorcentaje(node.campesenaMeta, node.campesenaEjecucion) | percent:'1.2-2' }}
          </span>
        </div>

        <!-- Full Popular -->
        <div class="hierarchy-metric-item estrategia-metric" *ngIf="node.fullPopularMeta !== null">
          <span class="estrategia-label">Full Popular:</span>
          <span class="hierarchy-percentage clickable"
                [ngClass]="getClaseSemaforo(calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion))"
                (click)="showMetaEjecucionPopup('Full Popular', node.fullPopularMeta, node.fullPopularEjecucion); $event.stopPropagation()">
            {{ calcularPorcentaje(node.fullPopularMeta, node.fullPopularEjecucion) | percent:'1.2-2' }}
          </span>
        </div>
      </div>
    </div>

    <div class="hierarchy-node-children" *ngIf="!node.isCollapsed && node.children.length > 0">
      <div *ngFor="let child of node.children; trackBy: trackByEstrategiaId">
        <ng-container *ngTemplateOutlet="formacionEstrategiaNodeTpl; context: { $implicit: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Plantilla recursiva para Poblaciones Vulnerables -->
<ng-template #poblacionesVulnerablesNodeTpl let-node>
  <div class="hierarchy-node-card" [style.margin-left.rem]="node.level * 2">
    <div class="hierarchy-node-header" (click)="toggleHierarchyNode(node)"
         [class.expandable]="node.children.length > 0">
      <div class="hierarchy-header-content">
        <span class="toggle-icon" *ngIf="node.children.length > 0">
          {{ node.isCollapsed ? 'â–º' : 'â–¼' }}
        </span>
        <span class="hierarchy-node-title">{{ node.descripcion }}</span>
      </div>

      <div class="hierarchy-metrics">
        <div class="hierarchy-metric-item hierarchy-percentage"
             [ngClass]="getClasePorcentaje(node.porcentaje / 100)">
          {{ node.porcentaje / 100 | percent:'1.2-2' }}
        </div>
        <div class="hierarchy-metric-item">
          <span class="metric-label">Meta:</span>
          <span class="metric-value">{{ node.meta | number:'1.0-0' }}</span>
        </div>
        <div class="hierarchy-metric-item">
          <span class="metric-label">EjecuciÃ³n:</span>
          <span class="metric-value">{{ node.ejecucion | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>

    <div class="hierarchy-node-children" *ngIf="!node.isCollapsed && node.children.length > 0">
      <div *ngFor="let child of node.children; trackBy: trackByHierarchyId">
        <ng-container *ngTemplateOutlet="poblacionesVulnerablesNodeTpl; context: { $implicit: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Modal para Meta/EjecuciÃ³n -->
<div class="modal-overlay" *ngIf="showMetaEjecucionModal" (click)="closeMetaEjecucionModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ modalData?.estrategia }}</h3>
      <button class="modal-close-btn" (click)="closeMetaEjecucionModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-metric">
        <span class="modal-label">Meta:</span>
        <span class="modal-value">{{ modalData?.meta | number:'1.0-0' }}</span>
      </div>
      <div class="modal-metric">
        <span class="modal-label">EjecuciÃ³n:</span>
        <span class="modal-value">{{ modalData?.ejecucion | number:'1.0-0' }}</span>
      </div>
      <div class="modal-metric">
        <span class="modal-label">Porcentaje:</span>
        <span class="modal-value" [ngClass]="getClaseSemaforo(modalData?.porcentaje || 0)">
          {{ (modalData?.porcentaje || 0) / 100 | percent:'1.2-2' }}
        </span>
      </div>
    </div>
  </div>
</div>